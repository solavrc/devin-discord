# PRD

この機能は、既存のSlack連携と同様のユーザー体験と機能性をDiscord上で提供することを目的としています。
DevinはDiscordと連携し、普段利用しているサーバーから直接タスクの依頼や対話を行うことができます。

## 主な機能と動作

1.  **DiscordからのDevin呼び出し**:
    *   任意のテキストチャンネルで `@Devin` (または設定したBot名) とメンションすることで、Devinにタスクを指示できます。ファイル添付も可能です。
    *   Devinはメンションされたメッセージのスレッド内で応答し、進捗報告や質問を行います。ユーザーはスレッド内でDevinと継続的に対話できます。

2.  **連携設定**:
    *   **サーバー連携**: Discordサーバーの管理者がDevin Botをサーバーに招待・追加します。
    *   **ユーザー連携 (任意)**: 各ユーザーが個別にDevinアカウントとDiscordアカウントを連携します (例: OAuth認証)。これにより、Webアプリで開始したセッションのDiscordチャンネルへのミラーリングや、Discordからのセッション開始時の作成者名の正確な表示が可能になる想定です。

3.  **キーワードによる制御**:
    *   Discordのメッセージ内に特定のキーワードを含めることで、Devinの動作を制御します。 (スラッシュコマンド `/devin <command>` やプレフィックス `!devin <command>` も補助的に利用可能とする場合があります)
        *   `mute` / `unmute`: このキーワードを含むメッセージを送信すると、Devinによるスレッドメッセージの読み取りを一時停止/再開します。
        *   `(aside)` または `!aside`: メッセージの先頭にこのキーワードを付けると、Devinはそのメッセージを無視します (例: `(aside) これは人間向けのコメントです`)。
        *   `sleep` / `archive`: このキーワードを含むメッセージを送信すると、セッションを一時停止/アーカイブします。
        *   `EXIT`: このキーワードを含むメッセージを送信すると、セッションを終了します。
        *   `snapshot:<snapshot名>`: このキーワードを含むメッセージを送信すると、指定した環境スナップショットでセッションを開始・利用します (例: `snapshot:my-dev-env タスクを開始してください`)。
        *   `playbook:<playbook名>`: このキーワードを含むメッセージを送信すると、指定したプレイブックでセッションを開始・利用します (例: `playbook:deploy-staging タスクを開始してください`)。

4.  **Discord通知**:
    *   Webアプリ上のDevinセッションでDiscord通知を有効にすると、Devinからのステータス更新（完了、エラー、質問など）が個人のDiscord DMに送信されます。

5.  **専用チャンネルの活用**:
    *   `#devin-runs` のような専用テキストチャンネルを作成することで、チーム内でのDevin利用状況の共有やコラボレーションを促進できます。

6.  **その他の機能**:
    *   Discordサーバー設定でDevin Botのニックネームを変更できます。
    *   連携に必要な権限はBot招待時に確認できます。

この連携により、Devinをチームの既存のコミュニケーションフロー (Discord) にシームレスに統合し、開発プロセスを効率化します。

# 要件定義

## 1. Discord Botの基本設定

*   1.1. Devin BotをDiscordサーバーに招待できること。
*   1.2. 招待時に必要な権限（メッセージの読み取り、送信、スレッド作成、ファイル添付など）が明確に提示され、管理者が承認できること。
*   1.3. Discordサーバー管理者がBotのニックネームを変更できること。

## 2. Devinセッションの開始

*   2.1. 任意のテキストチャンネルで `@Devin` （または設定されたニックネーム）を含むメッセージを送信することで、Devinセッションを開始できること。
*   2.2. セッション開始メッセージには、テキストによるタスク指示を含めることができること。
*   2.3. セッション開始メッセージには、ファイルを添付できること。（添付ファイルはDevinが利用できる必要がある）
*   2.4. セッション開始時に `snapshot:<snapshot名>` キーワードを含めることで、指定したスナップショット環境でセッションを開始できること。
*   2.5. セッション開始時に `playbook:<playbook名>` キーワードを含めることで、指定したプレイブックを実行するセッションを開始できること。

## 3. Devinとの対話（スレッド内）

*   3.1. Devinは、セッション開始メッセージに対してDiscordスレッドを作成し、その中で応答すること。
*   3.2. ユーザーは、作成されたスレッド内でDevinとテキストベースで対話（追加指示、質問応答など）できること。
*   3.3. Devinは、進捗状況、確認事項、エラーなどをスレッド内にメッセージとして投稿すること。
*   3.4. Devinは、必要に応じてスレッド内にファイル（生成物、ログなど）を投稿できること。

## 4. キーワードによるセッション制御

*   4.1. スレッド内で `mute` キーワードを含むメッセージを送信すると、Devinはそのスレッド以降のメッセージ読み取りを一時停止すること。
*   4.2. スレッド内で `unmute` キーワードを含むメッセージを送信すると、Devinはメッセージ読み取りを再開すること。（`mute`状態である必要がある）
*   4.3. メッセージの先頭に `(aside)` または `!aside` キーワードを付けて送信すると、Devinはそのメッセージの内容を無視すること。
*   4.4. スレッド内で `sleep` キーワードを含むメッセージを送信すると、Devinセッションが一時停止状態になること。
*   4.5. スレッド内で `archive` キーワードを含むメッセージを送信すると、Devinセッションがアーカイブ状態（実質終了だが記録は残る）になること。
*   4.6. スレッド内で `EXIT` キーワードを含むメッセージを送信すると、Devinセッションが完全に終了すること。
*   4.7. スレッド内で `snapshot:<snapshot名>` キーワードを含むメッセージを送信すると、Devinは指定されたスナップショット環境を認識し、以降のタスク実行に利用できること。（具体的な動作はDevin API仕様に依存）
*   4.8. スレッド内で `playbook:<playbook名>` キーワードを含むメッセージを送信すると、Devinは指定されたプレイブックを実行できること。（具体的な動作はDevin API仕様に依存）
*   4.9. (補助機能) スラッシュコマンド (`/devin <command>`) やプレフィックス (`!devin <command>`) でも上記キーワード相当の操作を実行できること。（詳細なコマンド体系は別途定義）

## 5. DevinアカウントとDiscordアカウントの連携 (任意)

*   5.1. ユーザーは、Webアプリなどの手段を通じて、自身のDevinアカウントとDiscordアカウントを紐付けできること。（OAuth認証などを想定）
*   5.2. アカウント連携が完了している場合、Discordから開始されたDevinセッションの作成者情報が、Devin側で正しく記録されること。（Web UIでの表示など）
*   5.3. アカウント連携が完了している場合、Webアプリで開始したDevinセッションの進行状況や結果を、指定したDiscordチャンネルのスレッドにミラーリング（通知）できること。 (ユーザーとBotの両方がチャンネルに参加している必要がある)

## 6. Discord DMによる通知

*   6.1. ユーザーは、Webアプリ上のDevinセッション設定で、Discord DMによる通知を有効化できること。（要アカウント連携）
*   6.2. 通知が有効な場合、Devinセッションの重要なステータス変更（完了、エラー発生、ユーザーへの質問など）が発生した際に、連携されたDiscordアカウントへDMで通知が送信されること。

## 7. その他

*   7.1. エラーハンドリング: Discord APIのエラー、Devin APIのエラーなどが発生した場合、適切なエラーメッセージをユーザーに（可能な限りスレッド内やDMで）通知すること。
*   7.2. セキュリティ: Discord Bot Tokenなどの機密情報は安全に管理されること。
